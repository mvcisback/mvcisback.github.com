<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Sufficiently Random/Moving_DXR_to_Elastic_Search</title>
      <!-- Latest compiled and minified CSS -->

      <link rel="stylesheet" type="text/css" href="../css/stylesheet.css" media="screen" />
      <link rel="stylesheet" type="text/css" href="../css/pygment_trac.css" media="screen" />
      <link rel="stylesheet" type="text/css" href="../css/pandoc.css" media="screen" />
    </head>

    <body>

      <header>
        <div class="container">
          <h1>~/mvc/<a href="../">sufficiently_random</a>/Moving_DXR_to_Elastic_Search</h1>
        </div>
        <div><h2></h2></div>
      </header>

      <div class="container">

          <div class="info">
    Posted on August 22, 2014
    
</div>
<h2>Moving_DXR_to_Elastic_Search</h2>
<p>DXR is moving from SQLite + Trillite<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> to Elastic Search. The DXR <a href="https://wiki.mozilla.org/DXR_Storages#Elasticsearch">wiki</a> documents the reasons for changing, but the reasons relevant to this post are:</p>
<ul>
<li>clean line based search</li>
<li>sparse attribute storage</li>
<li>incredibly flexible query and filter system</li>
</ul>
<h2 id="line-based-search">Line Based Search</h2>
<p>Line based allows us to display only the relevant lines. DXR already supported this to some extent, but involved byte offset black magic. We’ve gone ahead and done away with any such witchcraft in favor of line based indexing in Elastic Search. Now we can just annotate a line with multiple tags and use the inverted index to query for it later.</p>
<h2 id="sparse-attribute-storage">Sparse Attribute Storage</h2>
<p>When I mentioned tagging before, this referred to marking an Elastic Search document. These documents are standard NoSQL JSON blobs of structured data. By making the distinction between a “c-function” and “js-function” tag, we’re able to easily implement <em>multi language support</em>! Banzai!</p>
<h2 id="elastic-searches-query-dsl">Elastic Searches Query DSL</h2>
<p>Finally, elastic searches Token Analyzers and Query DSL allow us to design incredibly sophisticated queries. <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> ## Plugin Infrastructure and the C Plugin ##</p>
<h3 id="untangling-the-back-end-from-sqlite">Untangling the back-end from SQLite</h3>
<div class="figure">
<img src="../images/spaghetti.gif" />
</div>
<p>So I’d like to quickly run through the Clang Plugin at a conceptual level.</p>
<div class="figure">
<img src="../images/indexer.svg" />
</div>
<p>We first hook into the clang compiler to extract the abstract syntax tree (AST). We traverse the tree (multiple passes in some cases) fathering meta-data such as variable references, call sites, declarations, inheritance structure. The meta-data gets serialized as Key Value pairs dubbed “needles”<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> which are organized by line. DXR then sends the needles off to Elastic Search for indexing.</p>
<div class="figure">
<img src="../images/query.svg" />
</div>
<p>Next comes actually searching for the “needles”. This works by first submiting querying using DXR’s frontend. The query is transformed into a set of needles, which can be searched for using Elastic Search’s inverted index, Elastic Search will return a line and potentially a rank (depends on the type of query).</p>
<p>An important thing to note is that aside from retrieving the meta-data from Clang, allot of the process is language agnostic. This should accelerate the process of adding more support languages such as Rust<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a> and Python.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>A trigram indexer written for DXR<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>As we’ll see in a bit with type search, contorting ES to your will really comes down to playing with these two components.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Erik calls them needles in a haystack<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Actually, there is a patch for Rust support using the old SQLite backend…hopefully its not too bit rotted<a href="#fnref4">↩</a></p></li>
</ol>
</div>

      </div>

      <div class="footer">
          <div>
            Contact: <a href="https://twitter.com/mvcisback">@mvcisback</a>
            Code: <a href="https://github.com/mvcisback">Github</a>
          </div>
          <div>
            this site = 
            <a href="http://jaspervdj.be/hakyll">Hakyll</a> + 
            <a href="http://sundaykofax.github.io/baby-legs/">Theme</a> +
            <a href="http://pages.github.com/">Github Pages</a> +
            <a href="https://github.com/mvcisback/mvcisback.github.com">Source</a> +
            too much time
          </div>
      </div>
    </body>
</html>
