---
layout: post
title: Moving_DXR_to_Elastic_Search
---

DXR is moving from SQLite + Trillite[^2] to Elastic Search. The DXR [wiki](https://wiki.mozilla.org/DXR_Storages#Elasticsearch)
documents the reasons for changing, but the reasons relevant to this
post are:

- clean line based search
- sparse attribute storage
- incredibly flexible query and filter system

## Line Based Search ##

Line based allows us to display only the relevant lines.
DXR already supported this to some extent, but involved byte offset
black magic. We've gone ahead and done away with any such witchcraft in
favor of line based indexing in Elastic Search. Now we can just
annotate a line with multiple tags and use the inverted index to query
for it later.

## Sparse Attribute Storage ##

When I mentioned tagging before, this referred to marking an Elastic Search
document. These documents are standard NoSQL JSON blobs of structured data.
By making the distinction between a "c-function" and "js-function" tag, we're
able to easily implement _multi language support_! Banzai!


## Elastic Searches Query DSL ##

Finally, elastic searches Token Analyzers and Query DSL allow us to design
incredibly sophisticated queries. [^4] 
## Plugin Infrastructure and the C Plugin ##

### Untangling the back-end from SQLite ###

![](/images/spaghetti.gif)

So I'd like to quickly run through the Clang Plugin at a conceptual level.

![](/images/indexer.svg ) 

We first hook into the clang compiler to extract the abstract syntax tree (AST).
We traverse the tree (multiple passes in some cases) fathering
meta-data such as variable references, call sites, declarations, inheritance
structure. The meta-data gets serialized as Key Value pairs dubbed "needles"[^6]
which are organized by line. DXR then sends the needles off to Elastic Search for
indexing.

![](/images/query.svg ) 

Next comes actually searching for the "needles". This works by first submiting
querying using DXR's frontend. The query is transformed into a set of needles, which
can be searched for using Elastic Search's inverted index, Elastic Search will return
a line and potentially a rank (depends on the type of query).

An important thing to note is that aside from retrieving the meta-data from Clang,
allot of the process is language agnostic. This should accelerate the process of
adding more support languages such as Rust[^5] and Python.

[^2]: A trigram indexer written for DXR

[^4]: As we'll see in a bit with type search, contorting ES to your will really comes down to playing with these two components.

[^5]: Actually, there is a patch for Rust support using the old SQLite backend...hopefully its not too bit rotted

[^6]: Erik calls them needles in a haystack
